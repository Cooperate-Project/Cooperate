/*
 * generated by Xtext 2.11.0
 */
package de.cooperateproject.modeling.textual.usecase.tests

import com.google.inject.Inject
import de.cooperateproject.modeling.textual.usecase.usecase.UseCaseDiagram
import org.eclipse.xtext.testing.InjectWith
import org.eclipse.xtext.testing.XtextRunner
import org.eclipse.xtext.testing.util.ParseHelper
import org.junit.Assert
import org.junit.Test
import org.junit.runner.RunWith
import org.eclipse.xtext.testing.validation.ValidationTestHelper
import de.cooperateproject.modeling.textual.usecase.usecase.UsecasePackage
import org.eclipse.emf.ecore.resource.ResourceSet
import org.eclipse.emf.common.util.URI
import org.apache.commons.io.IOUtils
import java.util.Collections
import de.cooperateproject.modeling.textual.usecase.tests.scoping.util.UseCaseCustomizedInjectorProvider

@InjectWith(UseCaseCustomizedInjectorProvider.DefaultProvider)
class UsecaseParsingTest extends AbstractUseCaseTest{
	
	@Inject extension ValidationTestHelper
	
	override setup() {
		super.setup()
		rs.packageRegistry.put(UsecasePackage.eNS_URI, UsecasePackage.eINSTANCE)
	}
	
	@Test
	def void emptyDiagram() {
		val model = '''
			@start-ucd "someDiagram"
			rootElement RootElement
			@end-ucd
		'''.parse(rs)
		assertNoIssues(model)
	}
	
	@Test
	def void defineActorsAndSystems() {
		val model = '''
			@start-ucd "someDiagram"
			rootElement RootElement
			actor Alice
			sys System1
			@end-ucd
		'''.parse(rs)
		assertNoIssues(model)
	}
	
	@Test
	def void defineUseCases() {
		val model = '''
			@start-ucd "someDiagram"
			rootElement RootElement
			sys System1 {
				uc ConcreteUseCase1
				abstract uc AbstractUseCase1
				uc ConcreteUseCase2
			}
			@end-ucd
		'''.parse(rs)
		assertNoIssues(model)
	}
	
	@Test
	def void defineUseCasesWithExtensionPoints() {
		val model = '''
			@start-ucd "someDiagram"
			rootElement RootElement
			sys System1 {
				abstract uc AbstractUseCase1 {
					ep ExtensionPoint1
				}
			}
			@end-ucd
		'''.parse(rs)
		assertNoIssues(model)
	}
	
	@Test
	def void testAliasing() {
		val model = '''
			@start-ucd "someDiagram"
			rootElement RootElement
			actor "Employee of the month" as Bob
			sys System1 {
				uc "Concrete and Aliased Usecase 1" as ConcreteUseCase1
				abstract uc AbstractUseCase1 {
					ep "The real functionality" as AliasedExtensionPoint1
				}	
			}
			@end-ucd
		'''.parse(rs)
		assertNoIssues(model)
	}
	
	@Test
	def void testAssociations() {
		val model = '''
			@start-ucd "someDiagram"
			rootElement RootElement
			actor Alice
			actor "Employee of the month" as Bob
			sys System1 {
				uc "Concrete and Aliased Usecase 1" as ConcreteUseCase1
				abstract uc AbstractUseCase1 {
					ep ExtensionPoint1
				}
			}
			iac (Alice, ConcreteUseCase1)
			iac (Bob, AbstractUseCase1)
			@end-ucd
		'''.parse(rs)
		assertNoIssues(model)
	}
	
	@Test
	def void testQualifiedNames() {
		val model = '''
			@start-ucd "someDiagram"
			rootElement RootElement
			actor Alice
			actor "Employee of the month" as Bob
			sys System1 {
				uc "Concrete and Aliased Usecase 1" as ConcreteUseCase1
				abstract uc AbstractUseCase1 {
					ep ExtensionPoint1
				}
			}
			iac (RootElement.Alice, System1.ConcreteUseCase1)
			iac (Bob, RootElement.System1.AbstractUseCase1)
			@end-ucd
		'''.parse(rs)
		assertNoIssues(model)
	}
	
	@Test
	def void testIncludesAndExtends() {
		val model = '''
			@start-ucd "someDiagram"
			rootElement RootElement
			sys System1 {
				uc "Concrete and Aliased Usecase 1" as ConcreteUseCase1
				uc ConcreteUseCase2
				uc IncludedUseCase1
				uc Extension1ToAbstractUseCase1
				uc Extension2ToAbstractUseCase1
				abstract uc AbstractUseCase1 {
					ep ExtensionPoint1
					ep "The real functionality" as AliasedExtensionPoint1
				}
			}
			inc (ConcreteUseCase2, IncludedUseCase1)
			ext (Extension1ToAbstractUseCase1, AbstractUseCase1) ep[ExtensionPoint1]
			ext (Extension2ToAbstractUseCase1, AbstractUseCase1) ep[AliasedExtensionPoint1] cond["Sometimes"]
			@end-ucd
		'''.parse(rs)
		assertNoIssues(model)
	}
	
	@Test
	def void testGeneralization() {
		val model = '''
			@start-ucd "someDiagram"
			rootElement RootElement
			actor "Employee of the month" as Bob
			actor BobInABadMood
			sys System1 {
				abstract uc AbstractUseCase1
				uc IncludedUseCase1
				uc ConcreteUseCase2
			}
			iac (Bob, AbstractUseCase1)
			iac (BobInABadMood, ConcreteUseCase2)
			isa (BobInABadMood, Bob)
			isa (ConcreteUseCase2, AbstractUseCase1)
			inc (ConcreteUseCase2, IncludedUseCase1)
			@end-ucd
		'''.parse(rs)
		assertNoIssues(model)	
	}
	
	
	
	private static def parse(CharSequence text, ResourceSet rs) {
		val r = rs.createResource(URI.createFileURI("testmodels/UCParsingTest.uc"))
		val is = IOUtils.toInputStream(text);
		r.load(is, Collections.emptyMap());
		return r.contents.get(0) as UseCaseDiagram
	}
}
